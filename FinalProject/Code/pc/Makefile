# Author: Ramon de Araujo Borba < ramonborba97@gmail.com >
# Institution: UFSC
# Date: 02/03/2022
# File: Makefile

# Compiler
CC=g++

# Directory containing the source files
SRCDIR=src

# Directory containing the object files
OBJDIR=obj

# Output directory
OUTDIR=.

# Output file
OUTPUT=$(OUTDIR)/main

# List of source files
SRCS=$(shell find $(SRCDIR) -type f -name "*.cpp")

# List of correspondin object files
OBJS=$(patsubst $(SRCDIR)/%.cpp, $(OBJDIR)/%.o, $(SRCS))

# Dependencies lists generated by g++
DEPS=$(patsubst $(OBJDIR)/%.o, $(OBJDIR)/%.d, $(OBJS))

# Defailt target, points to main output
default: $(OUTPUT)

# Generates main output from object files
$(OUTPUT): $(OBJS)
	$(CC) -o $@ $^

# Include compiler generated dependencies lists
-include $(DEPS)

# Generates object files from corresponding source files
$(OBJDIR)/%.o: $(SRCDIR)/%.cpp
	mkdir -p $(@D)
	$(CC) -MMD -o $@ -c $<

# Remove all files generated in the compliation process
clean:
	rm -rf $(OBJDIR) $(OUTPUT)

# ------------------------- Test Section ---------------------------

TESTDIR=test
TESTOUT=$(TESTDIR)/test_main.out
TESTSRCS=$(TESTDIR)/test_main.cpp $(shell find $(SRCDIR) -type f -name "*.cpp" -and -not -name "main.cpp")
TESTOBJS=$(patsubst $(SRCDIR)/%.cpp, $(OBJDIR)/%.o, $(TESTSRCS))

test: $(TESTOUT)

$(TESTOUT): $(TESTOBJS)
	$(CC) -o $@ $^

cleantest:
	rm -rf $(OBJDIR) $(TESTOUT)

cleanall: clean cleantest